<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="读完就带你入门CSRF"><meta name="keywords" content="漏洞,CSRF"><meta name="author" content="Qug_,undefined"><meta name="copyright" content="Qug_"><title>读完就带你入门CSRF | Qug's Blog</title><link rel="shortcut icon" href="/my-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/gh/upupming/gitalk@36368e5dffd049e956cdbbd751ff96c28d8255cf/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#GET方式演示CSRF攻击"><span class="toc-number">1.</span> <span class="toc-text">GET方式演示CSRF攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#验证HTTP-Referer-字段"><span class="toc-number">2.</span> <span class="toc-text">验证HTTP Referer 字段</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#服务端验证请求的token一致性"><span class="toc-number">3.</span> <span class="toc-text">服务端验证请求的token一致性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Ajax防御CSRF"><span class="toc-number">4.</span> <span class="toc-text">Ajax防御CSRF</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结"><span class="toc-number">5.</span> <span class="toc-text">总结</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://avatars1.githubusercontent.com/u/24547164?s=460&amp;v=4"></div><div class="author-info__name text-center">Qug_</div><div class="author-info__description text-center">Life is only inevitable, there is no chance.</div><div class="follow-button"><a href="https://github.com/qinshuang1998" target="_blank">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">16</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">25</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">分类</span><span class="pull-right">8</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="http://h3c.qugcloud.cn" target="_blank">H3C-V7在线手册</a><a class="author-info-links__name text-center" href="http://music.qugcloud.cn" target="_blank">VIP音源下载</a><a class="author-info-links__name text-center" href="https://isk2y.github.io" target="_blank">iSk2y's Blog</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.qugcloud.cn/image/jpg/banner3.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Qug's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">读完就带你入门CSRF</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-04-19</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/信息安全/">信息安全</a><div class="post-meta-wordcount"><span>字数总计: </span><span class="word-count">1.8k</span><span class="post-meta__separator">|</span><span>阅读时长: 6 分钟</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><hr>
<p><strong>前言</strong>：不想读完的，可以理解这一句话，“如果你能理解XSS攻击的话，那么你一定认同XSS攻击是利用盗取的高权限cookie来进行的，相较而言CSRF并不干偷盗之事，而是借刀杀人”，这是我自己的感想，不认同的也不强求</p>
<hr>
<p>CSRF(cross-site request forgery)，跨站请求伪造，算了算了，概念性的我就不多说了，都能百度到，下面我直接说重点吧。</p>
<p>CSRF的攻击原理是什么，简单说就是<strong>利用</strong>了高权限帐号(如管理员)的登录状态或者授权状态去做一些后台操作，但实际这些状态并没有被我们直接获取到(获取那是XSS干的事)。</p>
<h4 id="GET方式演示CSRF攻击"><a href="#GET方式演示CSRF攻击" class="headerlink" title="GET方式演示CSRF攻击"></a><strong>GET方式演示CSRF攻击</strong></h4><p>我们这里假设有个网站test.com，包含一个登录页面(login.php)和一个付款页面(pay.php)</p>
<p>login.php：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    setcookie(&apos;uid&apos;, 1, time()+86400);</span><br><span class="line">    echo &quot;your uid is &#123;$_COOKIE[&apos;uid&apos;]&#125;&quot;;</span><br></pre></td></tr></table></figure>
<p>pay.php：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">   //身份验证</span><br><span class="line">    if (!isset($_COOKIE[&apos;uid&apos;]) || $_COOKIE[&apos;uid&apos;]&lt; 0) &#123;  </span><br><span class="line">        die(&apos;login error!&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">   //金额获取   </span><br><span class="line">    if (!isset($_GET[&apos;money&apos;])) &#123;</span><br><span class="line">        die(&apos;no money&apos;);</span><br><span class="line">    &#125;   </span><br><span class="line">   //收款人获取</span><br><span class="line">    if (!isset($_GET[&apos;to_who&apos;])) &#123;</span><br><span class="line">        die(&apos;nobody&apos;);</span><br><span class="line">    &#125;   </span><br><span class="line">    $uid = $_COOKIE[&apos;uid&apos;]; </span><br><span class="line">    $money = $_GET[&apos;money&apos;];</span><br><span class="line">    $to_who = $_GET[&apos;to_who&apos;];</span><br><span class="line">   //。。。。。。</span><br><span class="line">   //此处应该还有相关DB操作，略去</span><br><span class="line">    echo &quot;transfer &#123;$money&#125; yuan to &#123;$to_who&#125;!&quot;;</span><br></pre></td></tr></table></figure>
<p>打开login.php，模拟登录，可以看到登录成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">your uid is 1</span><br></pre></td></tr></table></figure>
<p>登录完成后我们打开pay.php进行转账，转1000元给father，GET请求构造：<a href="http://test.com/pay.php?money=1000&amp;to_who=father" target="_blank" rel="noopener">http://test.com/pay.php?money=1000&amp;to_who=father</a></p>
<p>访问得到转账成功的响应：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transfer 1000 yuan to father!</span><br></pre></td></tr></table></figure>
<p>以上是用户正常操作，这时黑客发现了该网站的CSRF漏洞，于是立刻伪造了一个页面，页面上预置了一个UC震惊部的超链接，超链接指向<a href="http://test.com/pay.php?money=1000&amp;to_who=hacker" target="_blank" rel="noopener">http://test.com/pay.php?money=1000&amp;to_who=hacker</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;body&gt;</span><br><span class="line">        &lt;a href=&quot;http://test.com/pay.php?money=1000&amp;to_who=hacker&quot; taget=&quot;_blank&quot;&gt;震惊！男人看了会沉默，女人看了会流泪！不转不是中国人！&lt;a/&gt;</span><br><span class="line">    &lt;/body&gt; </span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>如上，收款人被篡改成了黑客，如果我们是中国人，就一定会毫不犹豫的点击链接，因为不转不是中国人！！然后，然后。。。我们就把自己账户的1000元开心的转给了黑客。</p>
<p>为什么会出现这种情况，我们在别的网站点击链接居然能扣自己账户的钱？</p>
<p>点击链接前，我们已经登录了信任网站test.com，而这个这个链接是我们自己发送的，test.com会识别当前已经登录，然后转账，网站无法判断到底是谁让我们点击的。</p>
<p>从上面这个实例可知,完成CSRF攻击流程：</p>
<p>1、用户登录了信任的网站A，并且保存登录状态</p>
<p>2、黑客找出网站A没有防御的链接，通过社会工程学伪装，诱导点击。</p>
<p>3、只要登录状态保持，用户主动访问目标链接，则攻击成功。</p>
<p>有人说那每次访问其他网站，把之前的网站都注销。是的，这个办法可以，但这么做这现实吗？我们需要注销许多常用的网站，下次登录又要输入用户名和密码，极其反人类。这肯定不是最佳办法，防御措施应该让程序员考虑，用户别乱点链接是最重要的。</p>
<hr>
<p>以上演示了GET方式攻击，有人说那我把method改为POST吧，其实稍微动动脑也知道不行，POST请求我们同样可以伪造，隐藏表单的方式我们见多不怪了，所以仅仅依靠简单的POST传输依旧无济于事。</p>
<p>如此一来，不管哪种访问方式都可能受到攻击。所以，这并不是GET和POST谁更安全的问题，POST只是提高了攻击门槛和成本。</p>
<p>划重点，那么CSRF能够攻击的根本原因是：<strong>服务器无法识别你的来源是否可靠</strong>。</p>
<hr>
<p>最后，我们聊一聊前辈是如何防御CSRF攻击的：</p>
<p>防御的方法有很多：</p>
<p>1、比如加上验证码。但这么做很繁琐，并且影响用户体验。</p>
<p>2、比如转账需要二次密码验证，现在很多银行就这么搞的。</p>
<p>3、确认来源是否可靠（推荐）</p>
<p>1和2都是同一个思路，那就是验证请求合法性，从这一思路出发，前辈想出了下面几种方法：</p>
<h4 id="验证HTTP-Referer-字段"><a href="#验证HTTP-Referer-字段" class="headerlink" title="验证HTTP Referer 字段"></a><strong>验证HTTP Referer 字段</strong></h4><p>HTTP协议里面定义了一个访问来源的字段，这个字段叫Referer。黑客伪造的链接或表单是在其他网站上，所以我们可以判断Referer是否为自身网站，如果是，则允许访问，如果不是，则拒绝访问。</p>
<p>但是这种方法是有缺陷的，上面实验尝试过，如果对方在QQ上发送给你一个链接呢？点击的时候属于主动点击，此时一样没有Referer。程序会把它归属为安全请求，那么就被绕过了。并且如果某些低版本的浏览器存在漏洞（比如IE6），Referer很有可能被篡改，所以这个方法并非十全十美。</p>
<h4 id="服务端验证请求的token一致性"><a href="#服务端验证请求的token一致性" class="headerlink" title="服务端验证请求的token一致性"></a><strong>服务端验证请求的token一致性</strong></h4><p>CSRF攻击的核心原理就是利用用户验证信息储存cookie中，发送请求，使得服务器无法判断真伪，而token之所以能够拦截，就是因为它是CSRF攻击过程中几乎不可能伪造的东西。</p>
<p>实现原理：在服务端生成一个随机的token，加入到HTTP请求参数中，服务器拦截请求，查看发送的token和服务端的是否一致，若一致，则允许请求；若不一致，则拒绝请求。</p>
<p><strong>注意：一定要生成唯一的或者随机性较大的token。如果token可以被爆破，一样可以伪造请求，进行攻击。</strong></p>
<p><strong>参考文章：<a href="https://blog.csdn.net/li741350149/article/details/62887524" target="_blank" rel="noopener">https://blog.csdn.net/li741350149/article/details/62887524</a></strong></p>
<h4 id="Ajax防御CSRF"><a href="#Ajax防御CSRF" class="headerlink" title="Ajax防御CSRF"></a><strong>Ajax防御CSRF</strong></h4><p>实际上Ajax防御的思想也可以利用上面的token验证方式。</p>
<p>IBM上一篇文章说Ajax防御时，在 HTTP 头中自定义属性并验证token。</p>
<p>它是这么说的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">把 token 以参数的形式置于 HTTP 请求之中，而是把它放到 HTTP 头中自定义的属性里。通过 XMLHttpRequest 这个类，可以一次性给所有该类请求加上 csrftoken 这个 HTTP 头属性，并把 token 值放入其中。这样解决了上种方法在请求中加入 token 的不便，同时，通过 XMLHttpRequest 请求的地址不会被记录到浏览器的地址栏，也不用担心 token 会透过 Referer 泄露到其他网站中去。</span><br></pre></td></tr></table></figure>
<hr>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h4><p>CSRF防御原则：</p>
<ul>
<li>GET方式不能用于更新资源的操作</li>
<li>POST方式请求加上随机token验证</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Qug_</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.qugcloud.cn/2018/04/19/csrf-details/">https://www.qugcloud.cn/2018/04/19/csrf-details/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.qugcloud.cn" target="_blank">Qug's Blog</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/漏洞/">漏洞</a><a class="post-meta__tags" href="/tags/CSRF/">CSRF</a></div><div class="social-share" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2018/05/19/firewall-pwd/"><i class="fa fa-chevron-left">  </i><span>国内防火墙默认密码</span></a></div><div class="next-post pull-right"><a href="/2018/02/19/popping-14-el/"><span>珍贵录像-boogaloo的14种元素教学</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: 'af2e8d12e00142564b6f',
  clientSecret: '31eeda7d2c98f904c743a01a17f323fa0ed031fa',
  repo: 'qinshuang1998.github.io',
  owner: 'qinshuang1998',
  admin: 'qinshuang1998',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2017 - 2019 By Qug_</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="icp"><a><span>苏ICP备16063739号-1</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="/js/third-party/anime.min.js"></script><script src="/js/third-party/jquery.min.js"></script><script src="/js/third-party/jquery.fancybox.min.js"></script><script src="/js/third-party/velocity.min.js"></script><script src="/js/third-party/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.5.6"></script><script src="/js/fancybox.js?version=1.5.6"></script><script src="/js/sidebar.js?version=1.5.6"></script><script src="/js/copy.js?version=1.5.6"></script><script src="/js/fireworks.js?version=1.5.6"></script><script src="/js/transition.js?version=1.5.6"></script><script src="/js/scroll.js?version=1.5.6"></script><script src="/js/head.js?version=1.5.6"></script></body></html>